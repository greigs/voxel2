# STL Animation Tool (`animate_stl.py`)

This Python script, `animate_stl.py`, generates an MP4 animation from an STL file. The animation features the distinct components within the STL file "exploding" outwards from the center of the model and then imploding back to their original positions. Simultaneously, the entire model assembly spins horizontally. The animation is rendered from a fixed camera angle, looking down at the model at 45 degrees.

This tool is particularly useful for visualizing multi-part STL files, such as those generated by `process_vox.py` (e.g., `_gapped_diff.stl` files).

## Features

*   **Component Animation**: Individual, disconnected components within the STL are animated.
*   **Explosion/Implosion Effect**: Components move radially outwards from the model's centroid and then return.
*   **Spinning Model**: The entire assembly rotates horizontally during the animation.
*   **Configurable Parameters**: Animation duration, frames per second (FPS), explosion intensity, and spin speed can be adjusted via command-line arguments.
*   **Off-screen Rendering**: Uses PyVista for rendering, allowing it to run in headless environments.

## Dependencies

The script requires the following Python libraries:

*   `trimesh`: For loading and processing STL files.
*   `numpy`: For numerical operations, particularly vector and matrix math.
*   `pyvista`: For 3D plotting and animation rendering.
*   `imageio`: For creating the output animation file (e.g., MP4).
*   `imageio-ffmpeg`: (Often required by `imageio` for MP4 support).

You can install these dependencies using pip:
```bash
pip install trimesh numpy pyvista imageio imageio-ffmpeg
```
(If you have a `requirements.txt` that includes these, you can also use `pip install -r requirements.txt`)

## Usage

The script is run from the command line.

```bash
python animate_stl.py <input_stl_path> <output_animation_path> [options]
```

### Arguments

*   **`input_stl_path`** (required): Path to the input STL file. This file should ideally contain multiple distinct objects/components.
*   **`output_animation_path`** (required): Path where the generated animation file (e.g., `animation.mp4`) will be saved.

### Options

*   **`--duration <seconds>`**: Duration of the animation in seconds.
    *   Default: `10`
*   **`--fps <frames>`**: Frames per second for the animation.
    *   Default: `20`
*   **`--max_explosion_scale <scale>`**: Scale factor for the maximum explosion distance. This is relative to the initial distance of each component's centroid from the overall model centroid. For example, a scale of `1.5` means components will move out to 1.5 times their original distance from the center at the peak of the explosion. Must be `>= 1.0`.
    *   Default: `1.5`
*   **`--spin_revolutions <revolutions>`**: Total number of horizontal (yaw) revolutions the scene will make during the animation.
    *   Default: `2`

### Example

```bash
python c:\\repo\\voxel2\\animate_stl.py c:\\repo\\voxel2\\pug_gapped_diff.stl c:\\repo\\voxel2\\pug_animation.mp4 --duration 15 --fps 30 --max_explosion_scale 2.0 --spin_revolutions 3
```

This command will:
*   Load components from `c:\repo\voxel2\pug_gapped_diff.stl`.
*   Create a 15-second animation at 30 FPS.
*   Have components explode outwards to 2.0 times their initial distance from the center.
*   Spin the model 3 full revolutions.
*   Save the output to `c:\repo\voxel2\pug_animation.mp4`.

## How it Works

1.  **Load STL**: The input STL file is loaded using `trimesh`. If the STL contains a single mesh, it's split into its disconnected components.
2.  **Component Processing**: Each component is converted into a PyVista `PolyData` object.
3.  **Centroid Calculation**: The centroid of each component and the overall centroid of all components are calculated.
4.  **Animation Loop**: For each frame of the animation:
    *   The current time (`t_norm` from 0 to 1) determines the state of the explosion and spin.
    *   **Explosion**: An "explosion factor" (based on a sine wave) scales the initial displacement vector of each component from the overall centroid. This moves the component outwards and then back inwards.
    *   **Spin**: The entire scene is rotated around the Z-axis (up) based on the `current_spin_angle_deg`.
    *   **Translation**: Each component is translated to its new position.
    *   **Camera Setup**: The PyVista plotter's camera is positioned to look at the `overall_centroid` from a -45 degree elevation, with a distance calculated based on the model's span. The camera's azimuth is updated with the `current_spin_angle_deg`.
    *   **Render Frame**: The scene is rendered, and the frame is captured and appended to the output video file using `imageio`.
5.  **Save Output**: Once all frames are rendered, the animation file is finalized and saved.

## Notes

*   The script assumes that the Z-axis is the "up" direction for the model when setting the camera's `viewup` vector and applying spin.
*   The quality of component separation depends on the input STL file. If `trimesh` cannot split the mesh into meaningful components, the animation might not look as intended.
*   For very large or complex STL files, the animation rendering process can be time-consuming and memory-intensive.
